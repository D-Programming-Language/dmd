# Automatic name mangling test generation

## TL;DR

Run `dmd -J. -run generate_tests.d` from this directory.

It will generate a `cpp_mangling_test_<os>_<32|64>.d` file that you can then add
to the `test/compilable/` folder.

## test templates

They are defined in `name_mangling.tests`.

This file contains test templates each of them are separated from each other by a commented line of dashes like this :
`// ------`

### tags

The test template is defined by a set of unordered tags of the form `// <TAG>:`.

* DESCRIPTION: provide a description for this template. It's useful to find the template from the autogenerated code.
* NAMESPACE: (optional) D disallows multiple identical extern C++ namespace in a single file so tests have to be grouped by extern(C++) namespaces. The namespace is expressed as a d module. eg. `// NAMESPACE: a.b.c` will generate the test code into three nested namespaces.
* CPP: the cpp code template to be instanciated.
* D_SYMBOL: the d code template of the symbol to test. This is used to generate `static assert(<D_SYMBOL>.mangleof == <AUTOGENERATED>);`
* D: the d code template to be instanciated.

### code templates

In the following example `foo` is a variable :
`void |foo|() {}`

The generator will instanciate this template and replace it by `foo_<id>_`. This allows to match the mangled name in the object file back to the generated cpp and d code. This also allows to have a single file to compile (all symbols are different) and speeds up the process.

### the uppercased variables

The variables that are more than one character and all uppercased are special. They refer to `cpp2d` files in this directory.

A `cpp2d` file defines a set of translations from c++ to d, as a result the test template will be instanciated many times, once for each line in the file.

This allows to instanciate a particular template with all basic types for instance.
